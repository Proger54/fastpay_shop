name: Deploy React App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    env:
      SERVER_IP: ${{ secrets.IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    steps:
    - name: üöÄ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
      working-directory: frontend

    - name: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      run: CI=false npm run build
      working-directory: frontend

    - name: üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SERVER_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

    - name: üöÄ –ü–µ—Ä–µ–Ω–æ—Å —Ñ–∞–π–ª–æ–≤
      run: |
        rsync -az --delete --exclude '.git' frontend/build/ $SERVER_USER@$SERVER_IP:/var/www/shopy.ink/